var fetch=require("node-fetch"),multiparty=require("multiparty"),fs=require("fs"),qiniu=require("qiniu"),fileType=require("file-type"),http=require("http"),baseurl="http://www.xiaoweipian.com/";getApi=function(e,r){e.headers["x-forwarded-for"]||e.connection.remoteAddress||e.socket.remoteAddress||e.connection.socket.remoteAddress;var n="";switch(e.query.action){case"preview":n=baseurl+"Back/ArticleInfo?key="+e.query.key+"&xwp="+e.query.xwp;break;case"article":n=baseurl+"Home/Info?key="+e.query.key+"&xwp="+e.query.xwp+"&ArticlePassword="+e.query.pwd+"&url="+e.query.url;break;case"userarticle":n=baseurl+"User/Article?UserNumber="+e.query.number;break;case"comment":n=baseurl+"Api/Comment/ArticleComment?page=1&rows=10&New=1&ArticleNumber="+e.query.number;break;case"checkpwd":n=baseurl+"Article/CheckPowerPwd?ArticleID="+e.query.aid+"&ArticlePowerPwd="+e.query.pwd;break;case"user":n=baseurl+"User/Info?number="+e.query.number+"&url="+e.query.url}fetch(n,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(e){return e.text()}).then(function(e){r.send(e),r.end()}).catch(function(e){r.end()})},picApi=function(e,r){var n=e.query.url;fetch(n,{method:"GET"}).then(function(e){return e.buffer()}).then(function(e){var t=fileType(e);t.sourceurl=n,t.url="data:"+t.mime+";base64,"+e.toString("base64"),r.send(t),r.end()}).catch(function(e){r.end()})},commonPostApi=function(e,r){var n={};switch(e.query.name){case"commentSpu":n={spu_id:parseInt(e.query.spu_id,10),sku_id:parseInt(e.query.sku_id,10),msg:e.query.msg,star:parseInt(e.query.star,10),orderid:parseInt(e.query.orderid,10),photos:e.query.photos};break;case"commentReply":n={spu_id:parseInt(e.query.spu_id,10),sku_id:parseInt(e.query.sku_id,10),msg:e.query.msg,star:parseInt(e.query.star,10)};break;case"log":n={uid:parseInt(e.query.uid,10),uri:e.query.uri,ipaddr:e.headers["x-forwarded-for"]||e.connection.remoteAddress||e.socket.remoteAddress||e.connection.socket.remoteAddress,event:e.query.event};break;case"makeOrder":n={sku_id:parseInt(e.query.sku_id,10),contract_id:parseInt(e.query.contract_id,10),pay_type:parseInt(e.query.pay_type,10),sku_price_id:parseInt(e.query.sku_price_id,10),peroid_price_id:parseInt(e.query.peroid_price_id,10),access_id:[],coupons_id:[],count:parseInt(e.query.count,10),invoince_typ:parseInt(e.query.invoince_typ,10),invoince_title:e.query.invoince_title,addr_id:parseInt(e.query.addr_id,10)}}fetch(e.query.url,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Bearer "+e.query.access_token},body:JSON.stringify(n)}).then(function(e){return e.text()}).then(function(e){r.send(e),r.end()}).catch(function(e){r.end()})},registerApi=function(e,r){var n=e.query.Phone,t=e.query.Password,i=e.query.Password2,o=e.query.UserName,a=new Buffer("dxmall:dxmall").toString("base64");fetch(e.query.url,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Basic "+a},body:JSON.stringify({Phone:n,Password:t,Password2:i,UserName:o})}).then(function(e){return e.text()}).then(function(e){r.send(e),r.end()}).catch(function(e){r.end()})},loginApi=function(e,r){var n=e.query.username,t=e.query.userpwd,i=new Buffer("dxmall:dxmall").toString("base64");fetch(e.query.url,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Basic "+i},body:JSON.stringify({grant_type:"password",username:n,password:t})}).then(function(e){return e.text()}).then(function(e){r.send(e),r.end()}).catch(function(e){r.end()})},refreshApi=function(e,r){var n=e.query.refreshToken,t=new Buffer("dxmall:dxmall").toString("base64");fetch(e.query.url,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Basic "+t},body:JSON.stringify({grant_type:"refresh_token",refresh_token:n})}).then(function(e){return e.text()}).then(function(e){r.send(e),r.end()}).catch(function(e){r.end()})},addressEditApi=function(e,r){var n={is_def:parseInt(e.query.is_default,10),receiver:e.query.receiver,recv_phone:e.query.recv_phone,post_code:e.query.post_code,address:e.query.address,province:e.query.province,province_id:parseInt(e.query.province_id,10),city:e.query.city,city_id:parseInt(e.query.city_id,10),l3:e.query.l3,l3_id:parseInt(e.query.l3_id,10)};fetch(e.query.url,{method:e.query.method,headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Bearer "+e.query.access_token},body:JSON.stringify(n)}).then(function(e){return e.text()}).then(function(e){r.send(e),r.end()}).catch(function(e){r.end()})},deleteApi=function(e,r){fetch(e.query.url,{method:"DELETE",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Bearer "+e.query.access_token}}).then(function(e){return e.text()}).then(function(e){r.send(e),r.end()}).catch(function(e){r.end()})},uploadApi=function(e,r){new multiparty.Form({uploadDir:"./upload/"}).parse(e,function(e,n,t){var i=[];if(e)console.log("parse error: "+e);else{t.file.map(function(e,r){var n=e.path,t="./upload/"+(new Date).getTime().toString()+parseInt(1e3*Math.random()).toString()+"."+e.originalFilename.split(".")[1];i.push(t.substr(1)),fs.rename(n,t,function(e){e?console.log("rename error: "+e):console.log("rename ok")})})}r.writeHead(200,{"Content-Type":"application/json"}),r.end(JSON.stringify(i))})},uploadApi2=function(e,r){qiniu.conf.ACCESS_KEY="AUJrRnADlgVAM-30gaIsVNWCoxVK80Qf3diYqE1X",qiniu.conf.SECRET_KEY="_E_S26d5TUdr00K_D0xzeHHNhU-nv7z1US6RhFPz";var n=new qiniu.rs.PutPolicy("dxmall").token(),t=new qiniu.io.PutExtra;new multiparty.Form({uploadDir:"./upload/"}).parse(e,function(e,i,o){var a=[];if(e)console.log("parse error: "+e);else{var u=o.file;u.length,u.map(function(e,i){var o=e.path,u=(new Date).getTime().toString()+parseInt(1e3*Math.random()).toString()+"."+e.originalFilename.split(".")[1],s="./upload/"+u;fs.rename(o,s,function(e){e?console.log("rename error: "+e):(console.log("rename ok"),qiniu.io.putFile(n,u,s,t,function(e,n){e?console.log(e):(console.log(n.hash,n.key),a.push("http://o7lv5jbbo.bkt.clouddn.com/"+u)),r.writeHead(200,{"Content-Type":"application/json"}),r.end(JSON.stringify(a))}))})})}})};