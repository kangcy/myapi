@using EGT_OTA.Models
@{
    Layout = null;
}
@inherits System.Web.Mvc.WebViewPage
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta charset="utf-8" />
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="format-detection" content="telephone = no" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Back/bootstrap.css")" />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Back/table.css")"  />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Back/mui.min.css")"  />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Back/animate.min.css")"  />
    <style type="text/css">
        body {
            background: #fff;
        }

        #commentwrapper {
            position: fixed;
            top: 50px;
            width: 100%;
            background: #f5f5f5;
            z-index: 999;
        }

            #commentwrapper #remark {
                line-height: 1.25rem;
                margin: 20px 5% 0;
                width: 90%;
                min-height: 5rem;
                background: #fff;
                padding: 0.3rem 0.5rem;
                border: 1px solid #eee;
            }

                #commentwrapper #remark img {
                    width: 1rem;
                    vertical-align: middle;
                }

            #commentwrapper .flex-box {
                padding: 0.8rem 5%;
            }

            #commentwrapper .addresswrapper {
                border-radius: 30px;
                display: inline-block;
                line-height: 1.3rem;
                cursor: pointer;
            }

                #commentwrapper .addresswrapper img {
                    width: 0.8rem;
                    margin: 0.2rem;
                    margin-left: 0.5rem;
                }

            #commentwrapper #addresswrapper1 {
                border: 1px solid #0080ff;
            }

                #commentwrapper #addresswrapper1 span {
                    margin-right: 0.5rem;
                    color: #0080ff;
                }

            #commentwrapper #addresswrapper2 {
                border: 1px solid #999999;
            }

                #commentwrapper #addresswrapper2 span {
                    margin-right: 0.5rem;
                    color: #999;
                }

            #commentwrapper .commenticon {
                width: 1.5rem !important;
                height: 1.5rem;
                margin: 0.5rem 0px 0px 1.18rem;
                display: inline-block;
            }

            #commentwrapper #iconTab {
                background: #f5f5f5;
                display: inline-block;
                width: 100%;
            }

                #commentwrapper #iconTab div {
                    display: inline-block;
                    width: 100%;
                    border-top: 1px solid #eee;
                    border-bottom: 1px solid #eee;
                    float: left;
                    padding: 0.5rem 0px;
                    width: 20%;
                    border-left: 1px solid #eee;
                    text-align: center;
                }

                    #commentwrapper #iconTab div:first-child {
                        border-left: 0px;
                    }

                    #commentwrapper #iconTab div.curr {
                        background: #fff;
                    }

                    #commentwrapper #iconTab div img {
                        width: 1.5rem;
                        display: inline-block;
                    }

            #commentwrapper #divIcon.height {
                height: 0px;
            }

            #commentwrapper .mui-slider-group {
                margin-bottom: 1.5rem;
            }


        .mui-table-view-cell {
            background: #fff;
            padding: 0px 0.8rem;
        }

        .main {
            border-bottom: 1px solid #eee;
        }

        .oa-contact-cell.mui-table .mui-table-cell {
            padding: 0px;
            vertical-align: top;
        }

        .oa-contact-cell.comment .mui-table-cell {
            padding: 10px 0px 0px;
            vertical-align: top;
        }

        .oa-contact-cell {
            position: relative;
        }

        .oa-contact-avatar {
            width: 2.8rem;
        }

            .oa-contact-avatar img {
                width: 2rem !important;
                height: 2rem !important;
                border-radius: 50%;
            }

        .oa-contact-content {
            width: 100%;
            vertical-align: middle;
        }

        .oa-contact-icon {
            vertical-align: middle;
            width: 1.875rem;
            text-align: right;
        }

            .oa-contact-icon img {
                width: 2.5rem;
                float: right;
            }

        .oa-contact-date {
            width: 4.6875rem;
        }

        .mui-table-view-cell:after {
            left: 0px;
            background-color: transparent;
        }

        #header .curr {
            border-bottom: 2px solid #fff;
            padding-bottom: 0.1875rem;
        }

        .tip {
            text-align: left;
            background: #f5f5f5;
            padding: 0.5rem;
            width: 100%;
            position: relative;
            border-radius: 3px;
        }

            .tip:before {
                position: absolute;
                content: '';
                width: 0;
                height: 0;
                border: 6px solid transparent;
                border-bottom-color: #f5f5f5;
                left: 10px;
                top: -12px;
            }

        .mui-slider .mui-slider-group .mui-slider-item img {
            width: initial !important;
        }

        #addcomment {
            width: 100%;
            float: left;
            height: 2.8rem;
            line-height: 2.6rem;
            text-align: center;
        }

            #addcomment div {
                width: 90%;
                border-radius: 30px;
                background: #4087cb;
                display: inline-block;
                height: 2.1875rem;
                line-height: 2.1875rem;
                background-image: url(../images/article/pen2.png);
                background-repeat: no-repeat;
                background-position: 35% center;
                background-size: 1.25rem;
                text-indent: 10%;
            }

        .summary img {
            width: 1rem !important;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div id="wrapper">
        <div class="el-form-item full fl" style="padding: 5px 5%;">
            <div class="el-form-item__content full fl">
                <button id="ddl_user" index="-1" type="button" class="btn btn-default dropdown-toggle full" data-toggle="dropdown">
                    选择创建人
                                                  <span class="caret"></span>
                </button>
                <ul class="dropdown-menu tc full">
                    <li><a href="#" onclick="change(-1,'template','选择创建人')" class="ddl_user" index="-1">选择创建人</a></li>
                    @{
                        var list = (List<User>)ViewBag.Users;
                        foreach (var x in list)
                        {
                        <li><a href="#" onclick="change(@(x.ID),'ddl_user','@(x.NickName)')" class="ddl_user" index="@(x.ID)">@(x.NickName)</a></li>
                        }
                    }
                </ul>
            </div>
        </div>
        <div id="commentwrapper" class="hide">
            <div id='remark' class="emojionearea-editor f12" contenteditable="true" placeholder="250字内" tabindex="0"></div>
            <div class="flex-box flex-row" style="padding: 0.5rem 5%;">
                <div style="flex: 0 0 10%;" class="flex-item tl">
                    <img src="../Back/Images/smile.png" style="width: 1.3rem;" onclick="ShowIcon()" />
                </div>
                <div style="flex: 0 0 90%;" class="flex-item tr">
                    <div id="addresswrapper1" class="addresswrapper" onclick="ShowPosition(0)">
                        <img src="../Back/Images/dingwei.png" class="fl" />
                        <span class="f12" id="address"></span>
                    </div>
                    <span class="f10 underline" style="cursor: pointer;" id="position">获取定位</span>
                    <div id="addresswrapper2" class="addresswrapper hide" onclick="ShowPosition(1)">
                        <img src="../Back/Images/dingwei2.png" class="fl" />
                        <span class="f12">隐藏当前位置</span>
                    </div>
                </div>
            </div>
            <div class="full fl height" id="divIcon">
                <div id="slider0" class="mui-slider">
                    <div class="mui-slider-group mb0">
                        <!--人物-->
                        <div class="mui-slider-item">
                            <div id="slider1" class="mui-slider"></div>
                        </div>
                        <!--动植物-->
                        <div class="mui-slider-item">
                            <div id="slider2" class="mui-slider"></div>
                        </div>
                        <!--食物-->
                        <div class="mui-slider-item">
                            <div id="slider3" class="mui-slider"></div>
                        </div>
                        <!--心形-->
                        <div class="mui-slider-item">
                            <div id="slider4" class="mui-slider"></div>
                        </div>
                        <!--交通-->
                        <div class="mui-slider-item">
                            <div id="slider5" class="mui-slider"></div>
                        </div>
                    </div>
                </div>
                <div id="iconTab">
                    <div class="inline fl tc curr" index="0">
                        <img id="tab0" src="@Url.Content("~/Images/Icons/face/0.png")" />
                    </div>
                    <div class="inline fl tc" index="1">
                        <img id="tab1" src="@Url.Content("~/Images/Icons/animal/49.png")" />
                    </div>
                    <div class="inline fl tc" index="2">
                        <img id="tab2" src="@Url.Content("~/Images/Icons/food/0.png")" />
                    </div>
                    <div class="inline fl tc" index="3">
                        <img id="tab3" src="@Url.Content("~/Images/Icons/heart/0.png")" />
                    </div>
                    <div class="inline fl tc" index="4">
                        <img id="tab4" src="@Url.Content("~/Images/Icons/travel/0.png")" />
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-layer-btn" style="position: fixed; bottom: 20px; text-align: center; width: 100%;"><a class="layui-layer-btn0" onclick="Confirm()">添加评论</a></div>
    </div>
</body>
</html>
<script src="@Url.Content("~/Scripts/jquery-2.1.1.min.js")"></script>
<script src="@Url.Content("~/Back/bootstrap.min.js")"></script>
<script src="@Url.Content("~/Back/layer/layer.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/mui.min.js")"></script>
<script src="@Url.Content("~/Scripts/base.min.js")"></script>
<script type="text/javascript">
    var self = null;
    var action = "";
    var saveSelection, restoreSelection;
    var showIcon = false; //显示表情
    var showPosition = 1; //显示定位
    var $edit = null;

    var Number = "";
    var ArticleNumber = "";
    var ParentCommentNumber = "";
    var ParentUserNumber = "";
    var Count = 0;
    var NewId = 0; //最新添加评论ID
    var editor = null;

    var ArticleNumber = "";
    var Province = "";
    var City = "";
    var District = "";
    var Street = "";
    var DetailName = "";
    var CityCode = "";
    var Latitude = "";
    var Longitude = "";

    var isLoading = false;
    $(document).ready(function () {
        $edit = base.Get("remark");
        if (window.getSelection && document.createRange) {
            saveSelection = function (el) {
                var range = window.getSelection().getRangeAt(0);
                var preSelectionRange = range.cloneRange();
                preSelectionRange.selectNodeContents(el);
                preSelectionRange.setEnd(range.startContainer, range.startOffset);
                return preSelectionRange.toString().length;
            };

            restoreSelection = function (el, sel) {
                var charIndex = 0,
					range = document.createRange();
                range.setStart(el, 0);
                range.collapse(true);
                var nodeStack = [el],
					node, foundStart = false,
					stop = false;

                while (!stop && (node = nodeStack.pop())) {
                    if (node.nodeType == 3) {
                        var nextCharIndex = charIndex + node.length;
                        if (!foundStart && sel >= charIndex && sel <= nextCharIndex) {
                            range.setStart(node, sel - charIndex);
                            range.setEnd(node, sel - charIndex);
                            stop = true;
                        }
                        charIndex = nextCharIndex;
                    } else {
                        var i = node.childNodes.length;
                        while (i--) {
                            nodeStack.push(node.childNodes[i]);
                        }
                    }
                }

                sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
        } else if (document.selection && document.body.createTextRange) {
            saveSelection = function (el) {
                var selectedTextRange = document.selection.createRange(),
					preSelectionTextRange = document.body.createTextRange();
                preSelectionTextRange.moveToElementText(el);
                preSelectionTextRange.setEndPoint("EndToStart", selectedTextRange);
                var start = preSelectionTextRange.text.length;

                return [start, start + selectedTextRange.text.length];
            };

            restoreSelection = function (el, sel) {
                var textRange = document.body.createTextRange();
                textRange.moveToElementText(el);
                textRange.collapse(true);
                textRange.moveEnd("character", sel[1]);
                textRange.moveStart("character", sel[0]);
                textRange.select();
            };
        }

        var icons = [{
            Name: "face",
            Count: 80
        }, {
            Name: "animal",
            Count: 146
        }, {
            Name: "food",
            Count: 58
        }, {
            Name: "heart",
            Count: 97
        }, {
            Name: "travel",
            Count: 70
        }];

        var fragment = document.createDocumentFragment();
        var index = 0;
        var groupHtml = [];
        var tipHtml = [];

        $.each(icons, function (j, item) {
            index = 0;
            groupHtml = [];
            tipHtml = [];
            groupHtml.push('<div class="mui-slider-group">');
            tipHtml.push('<div class="mui-slider-indicator">');
            for (var i = 0; i < item.Count; i++) {
                index++;
                var el = document.createElement("img");
                el.setAttribute("src", "@(ViewBag.RootUrl)Images/Icons/" + item.Name + "/" + i + ".png");
                el.className = "commenticon";
                fragment.appendChild(el);
                if ((index >= 42 && index % 42 == 0) || (index == item.Count && index % 42 > 0)) {
                    var div = document.createElement("div");
                    div.className = "mui-slider-item";
                    div.appendChild(fragment);
                    groupHtml.push(div.outerHTML);
                    fragment = document.createDocumentFragment();
                    if (index == 42) {
                        tipHtml.push('<div class="mui-indicator mui-active"></div>');
                    } else {
                        tipHtml.push('<div class="mui-indicator"></div>');
                    }
                }
            }
            groupHtml.push('</div>');
            tipHtml.push('</div>');
            base.Get("slider" + (j + 1)).innerHTML = groupHtml.join('') + tipHtml.join('');
        });

        ShowComment(true);

        //重新定位
        $("#position").click(function () {
            var $this = $(this);
            layer.open({
                id: "map",
                type: 2,
                area: ['700px', '450px'],
                content: 'Map',
                title: "评论定位",
                scrollbar: false,
                success: function (layero, index) {
                    var iframeWin = window[layero.find('iframe')[0]['name']];
                    iframeWin.Init("");
                }
            });
        })
    });



    function Init(articlenumber, parentcommentnumber, parentusernumber) {
        ArticleNumber = articlenumber;
        ParentCommentNumber = parentcommentnumber;
        ParentUserNumber = parentusernumber;
    }

    //显示编辑器
    function ShowComment(show) {
        if (show == 0) {
            mask.close();
        } else {
            base.Get("commentwrapper").classList.remove("hide");
            base.Get("commentwrapper").classList.remove("bounceOutUp");
            base.Get("commentwrapper").classList.add("bounceInUp");
            if (!showIcon) {
                showIcon = true;
                //初始化
                mui("#slider1,#slider2,#slider3,#slider4,#slider5").slider({
                    interval: 0
                });
                var $slider = mui("#slider0").slider({
                    interval: 0
                });
                //表情分类切换
                $('#iconTab').on('click', 'div', function () {
                    //$edit.focus();
                    mui("#iconTab>div").each(function (i, model) {
                        model.classList.remove("curr");
                    })
                    $slider.gotoItem(this.getAttribute("index"));
                    this.classList.add("curr");
                });
                //添加表情
                mui('#commentwrapper').on('tap', '.commenticon', function () {
                    $edit.focus();
                    saveSelection($edit);
                    InsertIcon('<img src="' + this.getAttribute("src") + '" />');
                });
            }
        }
    }

    //显示定位
    function ShowPosition(show) {
        showPosition = show;
        if (show == 0) {
            $("#addresswrapper1,#position").addClass("hide");
            base.Get("addresswrapper2").classList.remove("hide");
        } else {
            base.Get("addresswrapper2").classList.add("hide");
            $("#addresswrapper1,#position").removeClass("hide");
        }
    }

    //显示表情
    function ShowIcon() {
        base.Get("divIcon").classList.toggle("height");
    }


    //新增表情
    function InsertIcon(html) {
        var sel, range;
        if (window.getSelection) {
            sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
                range = sel.getRangeAt(0);
                range.deleteContents();
                var el = document.createElement("div");
                el.innerHTML = html;
                var frag = document.createDocumentFragment(),
                    node, lastNode;
                while ((node = el.firstChild)) {
                    lastNode = frag.appendChild(node);
                }
                range.insertNode(frag);
                if (lastNode) {
                    range = range.cloneRange();
                    range.setStartAfter(lastNode);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }
        } else if (document.selection && document.selection.type != "Control") {
            document.selection.createRange().pasteHTML(html);
        }
    }

    function change(val, id, name) {
        $("#" + id).html(name).attr("index", val);
    }

    //更新定位
    function UpdateLocation(articlenumber, province, city, district, street, detailname, citycode, latitude, longitude) {
        Province = province;
        City = city;
        District = district;
        Street = street;
        DetailName = detailname;
        CityCode = citycode;
        Latitude = parseFloat(latitude).toFixed(2);
        Longitude = parseFloat(longitude).toFixed(2);
        $("#address").html(Province + City + District + Street + DetailName)
    }

    //提交评论
    function Confirm() {
        if (isLoading) {
            return;
        }
        isLoading = true;
        var userid = $("#ddl_user").attr("index");
        if (userid < 0) {
            layer.msg("请选择创建人");
            isLoading = false;
            return;
        }
        if (showPosition == 1 && base.IsNullOrEmpty(DetailName)) {
            layer.msg("请选择定位");
            isLoading = false;
            return;
        }
        var val = $edit.innerHTML;
        if (base.IsNullOrEmpty(val)) {
            isLoading = false;
            layer.msg("请填写内容");
            return;
        }
        layer.load();
        HttpPost("@(ViewBag.RootUrl)Comment/Edit_1_3", {
            ID: userid,
            ArticleNumber: ArticleNumber,
            ParentCommentNumber: ParentCommentNumber,
            ParentUserNumber: ParentUserNumber,
            Summary: escape(val),
            Province: Province,
            City: City,
            District: District,
            Street: Street,
            DetailName: DetailName,
            CityCode: CityCode,
            Latitude: Latitude,
            Longitude: Longitude,
            ShowPosition: showPosition
        }, function (data) {
            layer.msg(data.result ? "感谢您的评论" : data.message);
            isLoading = false;
            layer.closeAll('loading');
            if (data.result) {
                var index = parent.layer.getFrameIndex(window.name);
                parent.Refresh(false);
                parent.layer.close(index);
            }
        });
    }
</script>
